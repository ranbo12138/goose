<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸª¿é¹…é¸­æ€åŠ©æ‰‹ğŸ¦†</title>
    <style>
        :root {
            --bg: #121212; --card-bg: #1e1e1e; --ctrl-bg: #2d2d2d; --accent: #ffb300;
            --text-main: #eee; --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background: var(--bg); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 0; height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; padding-top: var(--safe-top);
        }
        
        /* Top Bar */
        .top-bar {
            height: 48px; background: #212121; border-bottom: 1px solid #333;
            display: grid; grid-template-columns: auto 1fr auto; align-items: center; padding: 0 12px; flex-shrink: 0; gap: 8px;
        }
        select { background: #333; color: #ccc; border: 1px solid #444; padding: 4px 2px; border-radius: 4px; font-size: 13px; font-weight: bold; }
        .round-switcher { display: flex; justify-content: center; gap: 6px; }
        .round-btn {
            width: 28px; height: 28px; border-radius: 4px; border: 1px solid #444; background: #333; color: #666;
            font-weight: bold; font-size: 13px; display: flex; align-items: center; justify-content: center; transition: all 0.1s;
        }
        .round-btn.active { background: #29b6f6; color: #000; border-color: #29b6f6; transform: scale(1.15); box-shadow: 0 2px 8px rgba(41, 182, 246, 0.2); }
        .settings-btn { font-size: 20px; padding: 4px; cursor: pointer; opacity: 0.8; }

        /* Mode Bar */
        .mode-bar {
            height: 0; overflow: hidden; background: var(--accent); color: black;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 13px; transition: height 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .mode-bar.active { height: 32px; }
        .mode-bar.report { background: #9c27b0; color: white; }
        .mode-bar.vouch { background: #2e7d32; color: white; }
        .mode-bar.knife { background: #c62828; color: white; }
        .mode-bar.walk { background: #1565c0; color: white; }

        /* Grid */
        .grid-container {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 8px;
            display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: 92px; gap: 6px;
            padding-bottom: calc(60px + var(--safe-bottom));
        }
        .cell {
            background: var(--card-bg); border: 1px solid #333; border-radius: 6px;
            display: flex; flex-direction: column; position: relative; overflow: hidden;
            transition: transform 0.05s; will-change: transform;
        }
        .cell:active { transform: scale(0.96); }
        .cell.selected { border: 2px solid var(--accent); filter: brightness(1.3); z-index: 2; }
        .cell-id-bar {
            height: 22px; display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 13px; text-shadow: 0 1px 2px rgba(0,0,0,0.4);
            border-bottom: 1px solid rgba(0,0,0,0.2);
        }
        .cell-tags { flex: 1; padding: 3px; display: flex; flex-direction: row; flex-wrap: wrap; align-content: flex-start; gap: 2px; }
        .mini-tag {
            font-size: 10px; padding: 2px 4px; border-radius: 2px; line-height: 1; height: 14px;
            white-space: nowrap; font-weight: bold; text-shadow: 0 1px 1px rgba(0,0,0,0.3); max-width: 100%;
        }
        .knife-badge {
            position: absolute; top: 0; right: 0; background: linear-gradient(135deg, #b71c1c, #e53935); color: white;
            width: 22px; height: 22px; border-radius: 0 0 0 8px; display: flex; align-items: center; justify-content: center;
            font-size: 12px; z-index: 10; box-shadow: -1px 1px 3px rgba(0,0,0,0.5); display: none;
        }
        .cell.has-knife .knife-badge { display: flex; }

        /* 16å· å‘†å‘†é¸Ÿ (Dodo) */
        .dodo-cell {
            background-image: url('https://i.ibb.co/pvm1SgsY/Screenshot-2026-01-17-18-30-00-49-2332cb9b27b851b548ba47a91682926c.jpg');
            background-size: cover; background-position: center;
            border-radius: 6px; border: 1px solid #333;
            cursor: pointer; opacity: 0.8; transition: transform 0.1s;
        }
        .dodo-cell:active { transform: scale(0.95); opacity: 1; }

        /* Bottom Control */
        .bottom-ctrl {
            position: fixed; bottom: 0; left: 0; width: 100%; height: calc(50px + var(--safe-bottom));
            background: #212121; border-top: 1px solid #333; display: flex; align-items: flex-start; justify-content: space-around;
            padding: 5px 10px 0 10px; z-index: 100; box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }
        .ctrl-btn {
            width: 23%; height: 40px; background: #383838; border: none; border-radius: 8px;
            font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s;
        }
        .ctrl-btn:active { transform: scale(0.95); }
        .ctrl-btn.active { background: #555; border: 1px solid #fff; filter: brightness(1.2); transform: translateY(-2px); }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(2px); z-index: 200;
            display: none; flex-direction: column; justify-content: flex-end;
        }
        .modal-overlay.active { display: flex; }
        .sheet {
            background: #252525; border-radius: 16px 16px 0 0; padding: 20px;
            padding-bottom: calc(30px + var(--safe-bottom)); max-height: 80vh; display: flex; flex-direction: column;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        
        /* Settings */
        .settings-title { font-size: 18px; font-weight: bold; color: #fff; margin-bottom: 20px; text-align: center; }
        .settings-btn-item {
            padding: 15px; margin-bottom: 12px; border-radius: 10px; border: none; font-size: 15px; font-weight: bold;
            text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-tag-mgr { background: #1a2a3a; color: #64b5f6; border: 1px solid #64b5f6; }
        .btn-reset-round { background: #372a18; color: #ffca28; border: 1px solid #ffca28; }
        .btn-new-game { background: #3a1c1c; color: #ef5350; border: 1px solid #ef5350; }
        .btn-clear-cache { background: #333; color: #999; border: 1px solid #555; font-size: 13px; }
        .footer-sign { text-align: center; color: #555; font-size: 10px; margin-top: 20px; font-family: monospace; letter-spacing: 1px; }

        /* Tag Editor */
        .tag-list-editor { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; max-height: 200px; overflow-y: auto; align-content: flex-start; }
        .tag-edit-item {
            padding: 6px 10px; border-radius: 4px; font-size: 12px; background: #333; color: #eee; border: 1px solid #555;
            display: flex; align-items: center; gap: 6px;
        }
        .tag-edit-item .del-btn {
            color: #ef5350; font-weight: bold; cursor: pointer; border-left: 1px solid #555; padding-left: 6px; font-size: 14px;
        }
        .add-tag-row { display: flex; gap: 5px; }
        .add-input { flex: 1; background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; font-size: 14px; }
        .color-select { background: #333; color: white; border: 1px solid #444; border-radius: 6px; font-size: 14px; }
        .add-btn { background: #2e7d32; color: white; border: none; padding: 0 15px; border-radius: 6px; font-weight: bold; font-size: 20px; }

        /* Record Modal */
        .tab-header { display: flex; background: #333; border-radius: 8px; padding: 3px; margin-bottom: 12px; }
        .tab-item { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: bold; color: #888; border-radius: 6px; transition: all 0.2s; }
        .tab-item.active { background: #555; color: white; }
        .tab-content { display: none; flex-wrap: wrap; gap: 8px; overflow-y: auto; align-content: flex-start; }
        .tab-content.show { display: flex; }
        .tag-btn { padding: 8px 12px; border-radius: 4px; font-size: 12px; background: #333; color: #ccc; border: 1px solid #444; }
        .tag-btn.active { background: rgba(255,255,255,0.1); border-color: #fff; color: #fff; font-weight: bold; }
    </style>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS ä¸“ç”¨è®¾ç½® (è®©è‹¹æœä¹Ÿèƒ½å½“APPç”¨) -->
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#212121">
</head>
<body>

    <!-- UI Structure -->
    <div class="top-bar">
        <select id="mapSelect" onchange="saveData()">
            <option value="base">åœ°ä¸‹å®¤</option>
            <option value="church">é¹…æ•™å ‚</option>
            <option value="ship">é£èˆ¹</option>
            <option value="jungle">ä¸›æ—</option>
        </select>
        <div class="round-switcher">
            <div class="round-btn active" onclick="switchRound(1)">1</div>
            <div class="round-btn" onclick="switchRound(2)">2</div>
            <div class="round-btn" onclick="switchRound(3)">3</div>
            <div class="round-btn" onclick="switchRound(4)">4</div>
            <div class="round-btn" onclick="switchRound(5)">5</div>
        </div>
        <div class="settings-btn" onclick="openSettings()">âš™ï¸</div>
    </div>

    <div id="modeBar" class="mode-bar"></div>
    <div class="grid-container" id="grid"></div>

    <div class="bottom-ctrl">
        <button class="ctrl-btn" style="color:#9c27b0" id="btn-report" onclick="setMode('report')">ğŸ¦¶</button>
        <button class="ctrl-btn" style="color:#2e7d32" id="btn-vouch" onclick="setMode('vouch')">ğŸ›¡ï¸</button>
        <button class="ctrl-btn" style="color:#c62828" id="btn-knife" onclick="setMode('knife')">ğŸ”ª</button>
        <button class="ctrl-btn" style="color:#1565c0" id="btn-walk" onclick="setMode('walk')">ğŸ‘«</button>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this) closeModal()">
        <div class="sheet">
            <div class="settings-title">è®¾ç½®</div>
            <button class="settings-btn-item btn-tag-mgr" onclick="openTagMgr()">ğŸ·ï¸ è‡ªå®šä¹‰è¡Œä¸ºæ ‡ç­¾</button>
            <button class="settings-btn-item btn-reset-round" onclick="resetCurrentRound()">ğŸ—‘ï¸ æ¸…ç©ºæœ¬è½®è®°å½•</button>
            <button class="settings-btn-item btn-new-game" onclick="resetGlobal()">ğŸ†• å¼€å¯æ–°å±€ (æ¸…ç©ºæ‰€æœ‰)</button>
            <button class="settings-btn-item btn-clear-cache" onclick="clearCache()">ğŸ§¹ å¼ºåˆ¶æ¸…ç†ç¼“å­˜</button>
            <div class="footer-sign">Designer by Mula Sakee</div>
        </div>
    </div>

    <div class="modal-overlay" id="tagMgrModal" onclick="if(event.target===this) closeModal()">
        <div class="sheet">
            <div class="settings-title">ğŸ·ï¸ ç®¡ç†æ ‡ç­¾</div>
            <div class="tag-list-editor" id="customTagList"></div>
            <div style="border-top:1px solid #444; margin:10px 0;"></div>
            <div class="add-tag-row">
                <input type="text" id="newTagName" class="add-input" placeholder="æ–°æ ‡ç­¾å">
                <select id="newTagColor" class="color-select">
                    <option value="wolf">ğŸ”´ çº¢</option>
                    <option value="good">ğŸŸ¢ ç»¿</option>
                    <option value="warn">ğŸŸ  æ©™</option>
                    <option value="neutral">âšª ç°</option>
                    <option value="blue">ğŸ”µ è“</option>
                    <option value="purple">ğŸŸ£ ç´«</option>
                </select>
                <button class="add-btn" onclick="addCustomTag()">+</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="recordModal" onclick="if(event.target===this) closeModal()">
        <div class="sheet">
            <div style="text-align:center; color:#888; margin-bottom:12px; font-size:12px;">
                <span style="color:#29b6f6">R<span id="displayRound">1</span></span> &mdash; #<span id="recordTitleId" style="font-weight:bold; color:white;"></span>
            </div>
            <div class="tab-header">
                <div class="tab-item active" onclick="switchTab('loc')">ğŸ“ åœ°ç‚¹</div>
                <div class="tab-item" onclick="switchTab('act')">ğŸƒ è¡Œä¸º</div>
            </div>
            <div class="tab-content show" id="tab-loc"></div>
            <div class="tab-content" id="tab-act"></div>
        </div>
    </div>

    <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('Service Worker Registered'))
      .catch((err) => console.error('SW Error:', err));
      }
    </script>
    
    <script>
        function vibrate(ms) { if(navigator.vibrate) navigator.vibrate(ms); }

        const colorMap = [
            { bg: '#EEEEEE', fg: '#000' }, { bg: '#1E88E5', fg: '#FFF' }, { bg: '#00695C', fg: '#FFF' }, 
            { bg: '#F8BBD0', fg: '#000' }, { bg: '#D32F2F', fg: '#FFF' }, { bg: '#FFEB3B', fg: '#000' }, 
            { bg: '#EF6C00', fg: '#FFF' }, { bg: '#5D4037', fg: '#FFF' }, { bg: '#212121', fg: '#FFF' }, 
            { bg: '#7B1FA2', fg: '#FFF' }, { bg: '#CCFF90', fg: '#000' }, { bg: '#80DEEA', fg: '#000' }, 
            { bg: '#F06292', fg: '#000' }, { bg: '#9E9E9E', fg: '#000' }, { bg: '#FFE0B2', fg: '#000' }
        ];

        const defaultActTags = [
            {t:'ç‹¼ä»»åŠ¡', c:'wolf'}, {t:'é¹…ä»»åŠ¡', c:'good'}, {t:'çœ‹è…¿ä¸æ‹‰', c:'warn'},
            {t:'å•èµ°', c:'neutral'}, {t:'å¤–ç½®ä½', c:'neutral'}, {t:'è´´è´´', c:'good'},
            {t:'åˆ’æ°´', c:'warn'}, {t:'å·çª¥', c:'warn'}, {t:'çª¥å­', c:'warn'}, {t:'ä¸åŠ¨', c:'wolf'}
        ];

        const mapData = {
            'base': ['å®éªŒå®¤','é”…ç‚‰æˆ¿','ä¹¦æˆ¿','é›¾æ´','ç¤¼å ‚','ç¥­å›','å‰å ‚','å‚¨è—å®¤','åœ°ç‰¢','æ”¶è—å®¤','å‚¨è—é—´','éš§é“å…¥å£','éš§é“','å‘'],
            'church': ['ç¤¼æ‹œå ‚','æ³•é™¢','å¹¿åœº','é“¶è¡Œ','çº¢ç¯åŒº','å°å±‹','æ¸¯å£','ç å¤´','è¿›å‡ºå£','ä»“åº“','å·¥å‚','è­¦å¯Ÿå±€','åŸå¸‚å¹¿åœº','é…’å‚','é…’é¦†','åŠå…¬å®¤','ç†å‘åº—'],
            'ship': ['æ¡¥æ¢','é€šè®¯é—´','è´§èˆ±','å‚¨ç‰©é—´','å¨±ä¹å®¤','æ­¦å™¨æˆ¿','å®¿èˆ','æ·‹æµ´é—´','ç”µæœºå®¤','åŒ»ç–—å®¤','ç›‘ç‹±','é£Ÿå ‚','å­µåŒ–å™¨','å‘åŠ¨æœº','ååº”å™¨'],
            'jungle': ['è®­ç»ƒåœº','å‰å ‚','å–·æ³‰','å¢“å®¤','å®ç‰©å®¤','ç¥­å›','è¥åœ°','ä¾›è´§åŒº','æ•¬æ‹œå‘','è¥¿å®å®¤','é‡‘éŠ®æ®¿','å‡†å¤‡å®¤','å‡†å¤‡åŒº']
        };

        const STORAGE_KEY = 'goose_duck_v28_final';
        
        let currentRound = 1;
        let roundsData = { 1: initP(), 2: initP(), 3: initP(), 4: initP(), 5: initP() };
        let players = roundsData[1];
        let activeTags = []; 

        function initP() { return Array.from({length: 15}, (_, i) => ({ id: i + 1, selected: false, hasKnife: false, tags: [] })); }

        function loadData() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if(raw) {
                try {
                    const data = JSON.parse(raw);
                    roundsData = data.rounds;
                    currentRound = data.curRound;
                    players = roundsData[currentRound];
                    if(data.map) document.getElementById('mapSelect').value = data.map;
                    if(data.activeTags && data.activeTags.length > 0) activeTags = data.activeTags;
                    else activeTags = [...defaultActTags];
                } catch(e) { activeTags = [...defaultActTags]; }
            } else {
                activeTags = [...defaultActTags];
            }
        }
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                rounds: roundsData, curRound: currentRound, 
                map: document.getElementById('mapSelect').value,
                activeTags: activeTags
            }));
        }

        let currentMode = 'normal';
        let tempId = null;
        let editingId = null;

        // --- Render Logic (Fixed) ---
        function render() {
            const grid = document.getElementById('grid');
            const fragment = document.createDocumentFragment();

            players.forEach(p => {
                const cell = document.createElement('div');
                cell.className = `cell ${p.selected ? 'selected' : ''} ${p.hasKnife ? 'has-knife' : ''}`;
                cell.onclick = () => onCellClick(p.id);
                
                const c = colorMap[p.id - 1];
                let displayTags = [];
                let skipTags = new Set();
                
                // 1. Scan for Mutual Relations FIRST
                p.tags.forEach(tag => {
                    // äº’ä¿é€»è¾‘
                    let match = tag.text.match(/^ä¿(\d+)$/);
                    if (match) {
                        const targetId = parseInt(match[1]);
                        const targetPlayer = players[targetId - 1];
                        if (targetPlayer && targetPlayer.tags.some(t => t.text === `ä¿${p.id}`)) {
                            const minC = colorMap[Math.min(p.id, targetId)-1];
                            const maxC = colorMap[Math.max(p.id, targetId)-1];
                            displayTags.push({
                                text: `${Math.min(p.id, targetId)},${Math.max(p.id, targetId)}äº’ä¿`,
                                style: `background: linear-gradient(90deg, ${minC.bg} 50%, ${maxC.bg} 50%); color: #fff; text-shadow: 0 0 2px #000; border: 1px solid #777;`
                            });
                            // Hide related single tags
                            skipTags.add(tag.text); // ä¿X
                            skipTags.add(`è¢«${targetId}ä¿`); // è¢«Xä¿
                        }
                    }

                    // äº’è¸©é€»è¾‘
                    match = tag.text.match(/^ğŸ¦¶è¸©(\d+)$/);
                    if (match) {
                        const targetId = parseInt(match[1]);
                        const targetPlayer = players[targetId - 1];
                        if (targetPlayer && targetPlayer.tags.some(t => t.text === `ğŸ¦¶è¸©${p.id}`)) {
                            const minC = colorMap[Math.min(p.id, targetId)-1];
                            const maxC = colorMap[Math.max(p.id, targetId)-1];
                            displayTags.push({
                                text: `${Math.min(p.id, targetId)},${Math.max(p.id, targetId)}äº’è¸©`,
                                style: `background: linear-gradient(90deg, ${minC.bg} 50%, ${maxC.bg} 50%); color: #fff; text-shadow: 0 0 2px #000; border: 1px solid #ef5350;`
                            });
                            // Hide related single tags
                            skipTags.add(tag.text); // è¸©X
                            skipTags.add(`è¢«${targetId}ğŸ¦¶`); // è¢«Xè¸©
                        }
                    }
                });

                // 2. Add remaining tags
                p.tags.forEach(t => {
                    if (!skipTags.has(t.text)) displayTags.push({ text: t.text, style: `background:${t.bg}; color:${t.fg}` });
                });

                let tagsHtml = displayTags.map(t => 
                    `<span class="mini-tag" style="${t.style}">${t.text}</span>`
                ).join('');

                cell.innerHTML = `
                    <div class="cell-id-bar" style="background:${c.bg}; color:${c.fg}">${p.id}</div>
                    <div class="knife-badge">ğŸ”ª</div>
                    <div class="cell-tags">${tagsHtml}</div>
                `;
                fragment.appendChild(cell);
            });

            // 16. Dodo Cell
            const dodo = document.createElement('div');
            dodo.className = 'dodo-cell';
            dodo.onclick = () => vibrate(10);
            fragment.appendChild(dodo);

            grid.innerHTML = '';
            grid.appendChild(fragment);
            updateUI();
        }

        function updateUI() {
            document.querySelectorAll('.round-btn').forEach((btn, idx) => {
                if(idx + 1 === currentRound) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            const bar = document.getElementById('modeBar');
            bar.className = `mode-bar ${currentMode} ${currentMode!=='normal'?'active':''}`;
            if(currentMode !== 'normal') {
                let text = '';
                if(currentMode === 'knife') text = 'ğŸ”ª ç‚¹å‡»æ ‡è®°æœ‰åˆ€ (ç‚¹å‡»å³å®Œæˆ)';
                if(currentMode === 'walk')  text = tempId ? `ğŸ‘« å’Œè°ä¸€èµ·ï¼Ÿ` : 'ğŸ‘« è°å’Œè°ä¸€èµ·ï¼Ÿ';
                if(currentMode === 'report') text = tempId ? `ğŸ¦¶ è¸©äº†è°ï¼Ÿ` : 'ğŸ¦¶ è¸©äº†è°ï¼Ÿ';
                if(currentMode === 'vouch') text = tempId ? `ğŸ›¡ï¸ ä¿äº†è°ï¼Ÿ` : 'ğŸ›¡ï¸ ä¿äº†è°ï¼Ÿ';
                bar.innerText = text;
            }

            document.querySelectorAll('.ctrl-btn').forEach(b => b.classList.remove('active'));
            if(currentMode !== 'normal') {
                const map = {'report':'btn-report', 'vouch':'btn-vouch', 'knife':'btn-knife', 'walk':'btn-walk'};
                document.getElementById(map[currentMode]).classList.add('active');
            }
        }

        window.switchRound = function(roundNum) {
            vibrate(10);
            currentRound = roundNum;
            players = roundsData[currentRound];
            currentMode = 'normal'; tempId = null;
            render(); saveData();
        }

        window.setMode = function(mode) {
            vibrate(20);
            if (currentMode === mode) {
                resetToNormal();
            } else {
                currentMode = mode;
                tempId = null;
                players.forEach(p => p.selected = false);
                render();
            }
        }

        function onCellClick(id) {
            vibrate(10);
            if (currentMode === 'normal') { openRecordModal(id); return; }
            if (currentMode === 'knife') {
                const p = players[id-1]; p.hasKnife = !p.hasKnife; 
                saveData(); render(); resetToNormal(); return;
            }
            if (currentMode === 'report') {
                if (!tempId) { tempId = id; players[id-1].selected = true; render(); }
                else {
                    if (id === tempId) return alert('ä¸èƒ½è‡ªè¸©');
                    const cB = colorMap[id-1]; const cA = colorMap[tempId-1];
                    toggleTag(tempId, `ğŸ¦¶è¸©${id}`, cB.bg, cB.fg);
                    toggleTag(id, `è¢«${tempId}ğŸ¦¶`, cA.bg, cA.fg);
                    resetToNormal(); // Auto exit
                }
                return;
            }
            if (currentMode === 'vouch') {
                if (!tempId) { tempId = id; players[id-1].selected = true; render(); }
                else {
                    if (id === tempId) { resetToNormal(); return; }
                    const cTarget = colorMap[id-1]; const cActor = colorMap[tempId-1];
                    toggleTag(tempId, `ä¿${id}`, cTarget.bg, cTarget.fg);
                    toggleTag(id, `è¢«${tempId}ä¿`, cActor.bg, cActor.fg);
                    resetToNormal(); // Auto exit
                }
                return;
            }
            if (currentMode === 'walk') {
                if (!tempId) { tempId = id; players[id-1].selected = true; render(); }
                else {
                    if (id === tempId) { resetToNormal(); return; }
                    const cTarget = colorMap[id-1]; const cActor = colorMap[tempId-1];
                    toggleTag(tempId, `ä¸€èµ·èµ°ğŸ‘«${id}`, cTarget.bg, cTarget.fg);
                    toggleTag(id, `ä¸€èµ·èµ°ğŸ‘«${tempId}`, cActor.bg, cActor.fg);
                    resetToNormal(); // Auto exit
                }
                return;
            }
        }

        function toggleTag(id, text, bg, fg) {
            const p = players[id-1];
            const idx = p.tags.findIndex(t => t.text === text);
            if(idx >= 0) p.tags.splice(idx, 1);
            else p.tags.push({text, bg, fg});
            saveData();
        }

        function resetToNormal() {
            currentMode = 'normal'; tempId = null;
            players.forEach(p => p.selected = false);
            render();
        }

        // --- Tag Manager ---
        function openTagMgr() {
            document.getElementById('settingsModal').classList.remove('active');
            document.getElementById('tagMgrModal').classList.add('active');
            renderTagMgrList();
        }

        function renderTagMgrList() {
            const list = document.getElementById('customTagList');
            list.innerHTML = '';
            // All tags removable
            activeTags.forEach((t, index) => {
                const el = document.createElement('div');
                el.className = 'tag-edit-item';
                el.innerHTML = `${t.t} <span class="del-btn" onclick="removeTag(${index})">Ã—</span>`;
                list.appendChild(el);
            });
        }

        window.addCustomTag = function() {
            const name = document.getElementById('newTagName').value.trim();
            const color = document.getElementById('newTagColor').value;
            if(!name) return;
            activeTags.push({t: name, c: color});
            document.getElementById('newTagName').value = '';
            saveData();
            renderTagMgrList();
        }

        window.removeTag = function(idx) {
            if(confirm('åˆ é™¤æ­¤æ ‡ç­¾ï¼Ÿ')) {
                activeTags.splice(idx, 1);
                saveData();
                renderTagMgrList();
            }
        }

        // --- Modals ---
        function openSettings() { document.getElementById('settingsModal').classList.add('active'); }
        function openRecordModal(id) {
            editingId = id;
            document.getElementById('displayRound').innerText = currentRound;
            document.getElementById('recordTitleId').innerText = id;
            const locBox = document.getElementById('tab-loc');
            locBox.innerHTML = '';
            const mapName = document.getElementById('mapSelect').value;
            (mapData[mapName] || []).forEach(t => { createBtn(t, locBox, '#e1f5fe', '#0277bd'); });
            
            const actBox = document.getElementById('tab-act');
            actBox.innerHTML = '';
            
            activeTags.forEach(item => {
                let bg='#f5f5f5', fg='#616161';
                if(item.c === 'wolf') { bg='#ffebee'; fg='#c62828'; }
                if(item.c === 'good') { bg='#e0f7fa'; fg='#006064'; }
                if(item.c === 'warn') { bg='#fff3e0'; fg='#e65100'; }
                if(item.c === 'neutral') { bg='#eceff1'; fg='#546e7a'; }
                if(item.c === 'blue') { bg='#e3f2fd'; fg='#1565c0'; }
                if(item.c === 'purple') { bg='#f3e5f5'; fg='#7b1fa2'; }
                createBtn(item.t, actBox, bg, fg);
            });
            document.getElementById('recordModal').classList.add('active');
        }

        function createBtn(text, container, bg, fg) {
            const btn = document.createElement('div');
            const hasIt = players[editingId-1].tags.some(t => t.text === text);
            btn.className = `tag-btn ${hasIt ? 'active' : ''}`;
            btn.innerText = text;
            if(hasIt) btn.style.cssText = `background: ${bg}; color: ${fg}; border-color: ${fg}; filter: brightness(0.9); box-shadow: 0 0 5px ${bg}`;
            else btn.style.cssText = `border-left: 3px solid ${bg}`;
            
            btn.onclick = () => {
                vibrate(5); toggleTag(editingId, text, bg, fg);
                openRecordModal(editingId); render();
            };
            container.appendChild(btn);
        }

        window.switchTab = function(type) {
            vibrate(5);
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('show'));
            const idx = type === 'loc' ? 0 : 1;
            document.querySelectorAll('.tab-item')[idx].classList.add('active');
            document.getElementById(`tab-${type}`).classList.add('show');
        }

        window.closeModal = function() { document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active')); }
        
        window.resetCurrentRound = function() {
            vibrate(30);
            if(confirm(`ç¡®å®šæ¸…ç©ºã€ç¬¬ ${currentRound} è½®ã€‘è®°å½•å—ï¼Ÿ`)) {
                roundsData[currentRound] = initP();
                players = roundsData[currentRound];
                resetToNormal(); saveData(); closeModal();
            }
        }

        window.resetGlobal = function() {
            vibrate(50);
            if(confirm('âš ï¸ å¼€å¯æ–°å±€ï¼Ÿ(æ¸…ç©ºæ‰€æœ‰è½®æ¬¡æ•°æ®, ä¿ç•™æ ‡ç­¾è®¾ç½®)')) {
                roundsData = { 1: initP(), 2: initP(), 3: initP(), 4: initP(), 5: initP() };
                currentRound = 1;
                players = roundsData[1];
                resetToNormal(); saveData(); closeModal();
            }
        }

        window.clearCache = function() {
            if(confirm('ğŸ§¹ å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼Ÿ(åŒ…æ‹¬è‡ªå®šä¹‰æ ‡ç­¾)')) { localStorage.removeItem(STORAGE_KEY); location.reload(); }
        }

        loadData();
        render();
    </script>
</body>
</html>
